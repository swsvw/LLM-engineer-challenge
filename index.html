<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PrivChat â€“ PII Detection</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=SF+Pro+Text:wght@400;600&display=swap">
  <style>
    /* [INSERT ALL THE STYLES YOU ALREADY HAVE] */
    /* ðŸŸ¢ Skip here: Assume you already pasted your CSS before */
  </style>
</head>
<body>
  <div class="window">
    <!-- Title Bar -->
    <div class="titlebar">
      <div class="hamburger">
        <div class="hamburger-line"></div>
        <div class="hamburger-line"></div>
        <div class="hamburger-line"></div>
      </div>
      <div class="title">PrivChat</div>
      <svg class="settings-icon" viewBox="0 0 24 24">
        <path d="M12 2C13.1 2 14 2.9 14 4C14 5.1 13.1 6 12 6C10.9 6 10 5.1 10 4C10 2.9 10.9 2 12 2ZM21 9V7L19 6.5C18.5 4.9 17.5 3.5 16.1 2.4L17 1L15.6 0L14.1 1.5C12.9 1 11.4 1 10.1 1.5L8.6 0L7.2 1L8.1 2.4C6.7 3.5 5.7 4.9 5.2 6.5L3 7V9L5.2 9.5C5.7 11.1 6.7 12.5 8.1 13.6L7.2 15L8.6 16L10.1 14.5C11.3 15 12.8 15 14.1 14.5L15.6 16L17 15L16.1 13.6C17.5 12.5 18.5 11.1 19 9.5L21 9ZM12 8C14.2 8 16 9.8 16 12S14.2 16 12 16S8 14.2 8 12S9.8 8 12 8Z"/>
      </svg>
    </div>

    <!-- Main Content -->
    <div class="content">
      <!-- Sidebar -->
      <div class="sidebar">
        <div class="chat-space-btn active">LLM Chat</div>
      </div>

      <!-- Chat Container -->
      <div class="chat-container">
        <!-- Chat Window -->
        <div class="chat-window">
          <textarea id="promptInput" placeholder="Enter a prompt..." style="width: 100%; height: 80%; background: transparent; border: 1px solid #444; color: #E0E0E0; font-size: 18px; padding: 10px; border-radius: 8px; resize: none;"></textarea>
          <button onclick="sendPrompt()" style="position: absolute; bottom: 20px; right: 20px; background: #00FF66; color: #121212; border: none; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-weight: bold;">Send</button>
        </div>

        <!-- Detected Entities Panel -->
        <div class="pii-details" id="piiDetails">
          <div class="pii-details-header">
            <div class="pii-details-title">Detected Entities</div>
            <div style="display: flex; align-items: center; gap: 12px;">
              <div class="pii-count" id="piiCount">0 items</div>
              <div class="close-btn" onclick="togglePiiDetails()">Ã—</div>
            </div>
          </div>
          <div id="piiItemsList"></div>
        </div>

        <!-- LLM Response Panel -->
        <div class="pii-details" id="llmResponseContainer" style="display: none;">
          <div class="pii-details-header">
            <div class="pii-details-title" style="color: #61dafb;">LLM Response</div>
          </div>
          <div id="llmResponseContent" style="color: #E0E0E0; font-size: 16px; line-height: 1.6;"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Script -->
  <script>
    let isPiiDetailsVisible = false;

    function togglePiiDetails() {
      const piiDetails = document.getElementById('piiDetails');
      isPiiDetailsVisible = !isPiiDetailsVisible;
      piiDetails.classList.toggle('active', isPiiDetailsVisible);
    }

    async function sendPrompt() {
      const prompt = document.getElementById('promptInput').value.trim();
      if (!prompt) return;

      try {
        const response = await fetch('http://localhost:8000/process', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ prompt })
        });

        const data = await response.json();
        updateUI(prompt, data);
      } catch (error) {
        alert("Error: Could not reach backend");
        console.error(error);
      }
    }

    function updateUI(prompt, data) {
      const { entities, llm_response } = data;

      updatePiiDetails(entities);
      updateHighlightedPrompt(prompt, entities);
      displayLlmResponse(llm_response);
    }

    function updatePiiDetails(entities) {
      const piiItemsList = document.getElementById('piiItemsList');
      const piiCount = document.getElementById('piiCount');
      piiItemsList.innerHTML = '';

      entities.forEach(entity => {
        const colorClass = entity.label === 'PERSON' ? 'orange' : 'blue';
        const item = `
          <div class="pii-item ${colorClass}">
            <div class="pii-info">
              <div class="pii-type ${colorClass}">${entity.label}</div>
              <div class="pii-value">${entity.text}</div>
            </div>
          </div>
        `;
        piiItemsList.innerHTML += item;
      });

      piiCount.textContent = `${entities.length} items`;
      document.getElementById('piiDetails').style.display = 'flex';
    }

    function updateHighlightedPrompt(prompt, entities) {
      let highlighted = prompt;
      entities.forEach(ent => {
        const colorClass = ent.label === 'PERSON' ? 'pii-highlight-orange' : 'pii-highlight-blue';
        const escapedText = ent.text.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
        const regex = new RegExp(`\\b${escapedText}\\b`, 'g');
        highlighted = highlighted.replace(regex, `<span class="${colorClass}">${ent.text}</span>`);
      });

      const chatWindow = document.querySelector('.chat-window');
      chatWindow.innerHTML = `
        <div class="chat-example">${highlighted}</div>
        <div class="pii-status" style="display: ${entities.length > 0 ? 'flex' : 'none'};">
          PII Detected
          <div class="pii-info-btn" onclick="togglePiiDetails()">i</div>
        </div>
        <div class="user-icon">ðŸ‘¤</div>
      `;
    }

    function displayLlmResponse(response) {
      const container = document.getElementById('llmResponseContainer');
      const content = document.getElementById('llmResponseContent');
      content.innerHTML = response.replace(/\n/g, '<br>');
      container.style.display = 'flex';
    }
  </script>
</body>
</html>
